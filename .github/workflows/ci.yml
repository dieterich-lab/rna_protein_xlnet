name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry and dependencies
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version
          poetry config virtualenvs.in-project true --local || true
          poetry install --no-interaction

      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run pytest -xvs tests/

  plugin-verification:
    name: Verify plugin entry point
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry and plugin
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="$HOME/.local/bin:$PATH"
          poetry install --no-interaction

      - name: Verify entry point registration
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "
          import importlib.metadata
          eps = {ep.name: ep.value for ep in importlib.metadata.entry_points(group='biolm.plugins')}
          assert 'xlnet' in eps, 'XLNet plugin not registered'
          assert 'xlnet_plugin' in eps['xlnet'], f'Wrong module: {eps[\"xlnet\"]}'
          print('âœ… XLNet plugin entry point verified')
          "
